{% extends "base.html" %}

{% block title %}Voice Interview Session - AI Interview Agent{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Side - AI Interviewer -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">AI Interviewer</h2>
                    <div class="text-sm text-gray-600">
                        <span id="question-counter">Question 1 of 8</span>
                    </div>
                </div>
                
                <!-- Interview Controls -->
                <div class="flex space-x-3 mb-4">
                    <button id="skip-question-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md font-medium text-sm">
                        ‚è≠Ô∏è Skip Question
                    </button>
                    <button id="end-interview-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium text-sm">
                        üõë End Interview
                    </button>
                </div>
                
                <!-- Timer -->
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">Time Elapsed:</span>
                        <span id="timer" class="text-lg font-bold text-blue-600">00:00</span>
                    </div>
                </div>
            </div>

            <!-- AI Interviewer Avatar -->
            <div class="text-center mb-6">
                <div id="interviewer-avatar" class="w-32 h-32 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mx-auto flex items-center justify-center mb-4">
                    <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <p id="interviewer-status" class="text-gray-600 text-sm">Ready to begin interview</p>
            </div>

            <!-- Question Display -->
            <div id="question-container" class="mb-6">
                <div id="loading-question" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-gray-600 mt-2">Preparing interview...</p>
                </div>
                
                <div id="question-content" class="hidden">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <div class="flex">
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    <span id="question-type" class="font-medium"></span> Question
                                    | <span id="question-difficulty" class="font-medium"></span> Level
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="prose max-w-none">
                        <div id="question-text" class="text-lg text-gray-900 leading-relaxed p-4 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300"></div>
                    </div>

                    <!-- Voice Controls -->
                    <div class="flex justify-center space-x-4 mt-6">
                        <button id="repeat-question-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium">
                            üîä Repeat Question
                        </button>
                    </div>
                </div>

                <div id="interview-completed" class="hidden text-center py-8">
                    <div class="text-green-600">
                        <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mt-2">Interview Completed!</h3>
                    <p class="text-gray-600 mt-2">Thank you for completing the voice interview.</p>
                    <button id="view-results-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md font-medium">
                        View Results
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Side - Voice Response Only -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-900">üé§ Voice Response Required</h3>
                <p class="text-sm text-red-600 font-medium">Note: Only voice answers are accepted in this interview</p>
            </div>

            <!-- Voice Status -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <h4 class="font-medium text-blue-900 mb-2">üéôÔ∏è Voice Interview Instructions:</h4>
                <ol class="text-sm text-blue-800 space-y-1">
                    <li>1. üéß Listen to the AI interviewer's question</li>
                    <li>2. üé§ Record your voice answer (minimum 30 seconds)</li>
                    <li>3. ‚¨ÜÔ∏è Upload your audio file for AI evaluation</li>
                    <li>4. ‚è≠Ô∏è Proceed to the next question automatically</li>
                </ol>
            </div>

            <!-- Audio Recording Area -->
            <div id="voice-recording-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4">
                <div id="voice-idle">
                    <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                    <p class="text-gray-600 mb-4">Ready to record your voice answer</p>
                    <p class="text-sm text-gray-500">Click "Start Recording" or upload an audio file</p>
                </div>
            </div>

            <!-- Recording Controls -->
            <div class="flex justify-center space-x-4 mb-6">
                <button id="start-recording-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md font-medium">
                    üé§ Start Recording
                </button>
                <button id="stop-recording-btn" class="hidden bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-md font-medium">
                    ‚èπÔ∏è Stop Recording
                </button>
            </div>

            <!-- File Upload Alternative -->
            <div class="border-t pt-4">
                <p class="text-center text-sm text-gray-600 mb-3">Or upload a pre-recorded audio file:</p>
                <form id="audio-upload-form" enctype="multipart/form-data">
                    <input type="file" id="audio-file" name="audio" accept="audio/*" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-3">
                    <button type="submit" id="upload-audio-btn"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium">
                        üì§ Upload & Submit Voice Answer
                    </button>
                </form>
            </div>

            <!-- Answer Feedback -->
            <div id="answer-feedback" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-md">
                <h4 class="font-medium text-green-900">‚úÖ Voice Answer Processed!</h4>
                <p class="text-sm text-green-700 mt-1">Score: <span id="answer-score"></span>/10</p>
                <p class="text-sm text-green-600 mt-2" id="answer-feedback-text"></p>
                <p class="text-xs text-gray-500 mt-3">Moving to next question in 3 seconds...</p>
            </div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="mt-8 bg-white shadow rounded-lg p-4">
        <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Interview Progress</span>
            <span class="text-sm text-gray-600" id="progress-text">0% Complete</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>
</div>

<script>
let interviewId = {{ interview.id }};
let currentQuestion = null;
let questionNumber = 0;
let totalQuestions = 8;
let startTime = Date.now();
let questionStartTime = Date.now();
let isGreetingPhase = true;

// Initialize interview with greeting
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    startTimer();
    startInterviewWithGreeting();
});

function setupEventListeners() {
    // Interview controls
    document.getElementById('skip-question-btn').addEventListener('click', skipQuestion);
    document.getElementById('end-interview-btn').addEventListener('click', endInterviewEarly);
    document.getElementById('repeat-question-btn').addEventListener('click', repeatQuestion);
    
    // Audio controls
    document.getElementById('start-recording-btn').addEventListener('click', startRecording);
    document.getElementById('stop-recording-btn').addEventListener('click', stopRecording);
    document.getElementById('audio-upload-form').addEventListener('submit', handleAudioUpload);
    
    // Results
    document.getElementById('view-results-btn').addEventListener('click', function() {
        window.location.href = `/results/${interviewId}`;
    });
}

async function startInterviewWithGreeting() {
    // Start with AI greeting
    document.getElementById('interviewer-status').textContent = 'Greeting candidate...';
    
    const greetingMessage = `Hello! Welcome to your AI-powered voice interview. I'm your virtual interviewer today. We'll be conducting a comprehensive assessment of your skills and experience. Please ensure your microphone is working properly. Let's begin with our first question.`;
    
    await speakMessage(greetingMessage);
    
    // Wait for greeting to finish, then load first question
    setTimeout(() => {
        isGreetingPhase = false;
        loadNextQuestion();
    }, 8000); // Allow time for greeting
}

async function loadNextQuestion() {
    try {
        document.getElementById('loading-question').classList.remove('hidden');
        document.getElementById('question-content').classList.add('hidden');
        
        const response = await fetch(`/api/interview/${interviewId}/next-question`);
        const data = await response.json();
        
        if (data.completed) {
            showInterviewCompleted(data);
        } else {
            displayQuestion(data);
        }
    } catch (error) {
        console.error('Error loading question:', error);
        alert('Failed to load question. Please refresh the page.');
    }
}

function displayQuestion(data) {
    currentQuestion = data.question;
    questionNumber = data.question_number;
    questionStartTime = Date.now();
    
    // Update UI
    document.getElementById('question-text').textContent = currentQuestion.text;
    document.getElementById('question-type').textContent = currentQuestion.type;
    document.getElementById('question-difficulty').textContent = currentQuestion.difficulty;
    document.getElementById('question-counter').textContent = `Question ${questionNumber} of ${totalQuestions}`;
    
    // Update progress
    const progress = (questionNumber / totalQuestions) * 100;
    document.getElementById('progress-bar').style.width = progress + '%';
    document.getElementById('progress-text').textContent = Math.round(progress) + '% Complete';
    
    // Show question content
    document.getElementById('loading-question').classList.add('hidden');
    document.getElementById('question-content').classList.remove('hidden');
    
    // Reset answer area
    resetAnswerArea();
    
    // Auto-speak the question
    speakMessage(currentQuestion.text);
}

async function speakMessage(message) {
    try {
        document.getElementById('interviewer-status').textContent = 'Speaking...';
        document.getElementById('interviewer-avatar').classList.add('animate-pulse');
        
        const response = await fetch('/api/voice/speak-question', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question_text: message })
        });
        
        if (response.ok) {
            console.log('AI speaking message');
            
            setTimeout(() => {
                document.getElementById('interviewer-status').textContent = 'Waiting for your voice response...';
                document.getElementById('interviewer-avatar').classList.remove('animate-pulse');
            }, 3000);
        }
    } catch (error) {
        console.error('Error speaking message:', error);
    }
}

function repeatQuestion() {
    if (currentQuestion) {
        speakMessage(currentQuestion.text);
    }
}

async function skipQuestion() {
    if (confirm('Are you sure you want to skip this question? This will affect your overall score.')) {
        // Submit empty answer for skipped question
        await submitAnswer("Question skipped by candidate", true);
    }
}

async function endInterviewEarly() {
    if (confirm('Are you sure you want to end the interview early? You will receive results based on questions answered so far.')) {
        try {
            const response = await fetch(`/api/interview/${interviewId}/end-early`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (response.ok) {
                const data = await response.json();
                showInterviewCompleted(data);
            }
        } catch (error) {
            console.error('Error ending interview:', error);
            window.location.href = `/results/${interviewId}`;
        }
    }
}

// Voice recording functions (simplified - you can integrate with VAPI here)
function startRecording() {
    document.getElementById('start-recording-btn').classList.add('hidden');
    document.getElementById('stop-recording-btn').classList.remove('hidden');
    
    document.getElementById('voice-idle').innerHTML = `
        <div class="animate-pulse">
            <svg class="mx-auto h-16 w-16 text-red-500 mb-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
        </div>
        <p class="text-red-600 font-semibold">üé§ Recording... Speak now!</p>
    `;
    
    // Here you can integrate VAPI or other voice recording service
    console.log('Recording started - integrate VAPI here');
}

function stopRecording() {
    document.getElementById('start-recording-btn').classList.remove('hidden');
    document.getElementById('stop-recording-btn').classList.add('hidden');
    
    document.getElementById('voice-idle').innerHTML = `
        <svg class="mx-auto h-16 w-16 text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
        </svg>
        <p class="text-blue-600 font-semibold">Processing recording...</p>
    `;
    
    // Here you would process the recorded audio
    // For now, simulate with a delay
    setTimeout(() => {
        submitAnswer("Simulated voice response from recording", false);
    }, 2000);
}

async function handleAudioUpload(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('audio-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select an audio file');
        return;
    }
    
    const uploadBtn = document.getElementById('upload-audio-btn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'üîÑ Processing Voice...';
    
    try {
        const formData = new FormData();
        formData.append('audio', file);
        
        const response = await fetch('/api/voice/upload-audio', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            await submitAnswer(result.text, false);
        } else {
            alert('Voice processing failed: ' + result.error);
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('Failed to process voice answer');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'üì§ Upload & Submit Voice Answer';
    }
}

async function submitAnswer(answerText, isSkipped = false) {
    try {
        const timeTaken = Math.round((Date.now() - questionStartTime) / 1000);
        
        const response = await fetch(`/api/interview/${interviewId}/submit-answer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                question_id: currentQuestion.id,
                answer_text: answerText,
                time_taken_seconds: timeTaken,
                is_skipped: isSkipped
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Show feedback
            document.getElementById('answer-score').textContent = isSkipped ? '0' : result.score;
            document.getElementById('answer-feedback-text').textContent = isSkipped ? 'Question was skipped' : result.feedback;
            document.getElementById('answer-feedback').classList.remove('hidden');
            
            // Auto-advance to next question
            setTimeout(loadNextQuestion, 3000);
        } else {
            alert('Error submitting answer: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to submit answer. Please try again.');
    }
}

function showInterviewCompleted(data) {
    document.getElementById('loading-question').classList.add('hidden');
    document.getElementById('question-content').classList.add('hidden');
    document.getElementById('interview-completed').classList.remove('hidden');
    
    // Update progress to 100%
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('progress-text').textContent = '100% Complete';
    
    // Speak completion message
    const completionMessage = `Thank you for completing your voice interview! Your overall performance score is ${data.overall_score} out of 10. You can now view your detailed results and feedback.`;
    speakMessage(completionMessage);
}

function resetAnswerArea() {
    document.getElementById('audio-file').value = '';
    document.getElementById('answer-feedback').classList.add('hidden');
    
    document.getElementById('voice-idle').innerHTML = `
        <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
        </svg>
        <p class="text-gray-600 mb-4">Ready to record your voice answer</p>
        <p class="text-sm text-gray-500">Click "Start Recording" or upload an audio file</p>
    `;
}

function startTimer() {
    setInterval(function() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timer').textContent = 
            String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    }, 1000);
}
</script>
{% endblock %}
