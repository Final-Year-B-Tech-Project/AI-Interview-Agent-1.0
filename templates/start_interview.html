{% extends "base.html" %}

{% block title %}Start Interview - AI Interview Agent{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Start New Interview</h1>
        <p class="text-gray-600">Configure your interview settings and begin practicing</p>
    </div>

    <div class="bg-white shadow-lg rounded-lg p-8">
        <form id="start-interview-form" class="space-y-6">
            <!-- Domain Selection -->
            <div>
                <label for="domain" class="block text-sm font-medium text-gray-700 mb-2">
                    Interview Domain
                </label>
                <select id="domain" name="domain_id" required
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select a domain</option>
                    {% for domain in domains %}
                        <option value="{{ domain.id }}">{{ domain.name }} - {{ domain.description }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Difficulty Level -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Difficulty Level
                </label>
                <div class="grid grid-cols-3 gap-4">
                    <label class="relative cursor-pointer">
                        <input type="radio" name="difficulty_level" value="beginner" required class="sr-only">
                        <div class="difficulty-option border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                            <div class="text-center">
                                <div class="text-green-600 font-semibold">Beginner</div>
                                <div class="text-sm text-gray-600 mt-1">Basic concepts and fundamentals</div>
                            </div>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer">
                        <input type="radio" name="difficulty_level" value="intermediate" required class="sr-only">
                        <div class="difficulty-option border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                            <div class="text-center">
                                <div class="text-yellow-600 font-semibold">Intermediate</div>
                                <div class="text-sm text-gray-600 mt-1">Applied knowledge and scenarios</div>
                            </div>
                        </div>
                    </label>
                    
                    <label class="relative cursor-pointer">
                        <input type="radio" name="difficulty_level" value="expert" required class="sr-only">
                        <div class="difficulty-option border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                            <div class="text-center">
                                <div class="text-red-600 font-semibold">Expert</div>
                                <div class="text-sm text-gray-600 mt-1">Advanced topics and design</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Duration -->
            <div>
                <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">
                    Interview Duration (minutes)
                </label>
                <select id="duration" name="duration_minutes"
                        class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="15">15 minutes</option>
                    <option value="30" selected>30 minutes</option>
                    <option value="45">45 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>

            <!-- Start Button -->
            <div class="flex justify-center">
                <button type="submit" id="start-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors">
                    Start Interview
                </button>
            </div>
        </form>
    </div>
</div>

<!-- IMPORTANT: Add this CSS -->
<style>
input[type="radio"]:checked + .difficulty-option {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
}
</style>

<!-- IMPORTANT: Add this JavaScript -->
<script>
console.log('Start interview page loaded');

// Handle form submission
document.getElementById('start-interview-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Form submitted');
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Validate required fields
    if (!data.domain_id) {
        alert('Please select a domain');
        return;
    }
    
    if (!data.difficulty_level) {
        alert('Please select a difficulty level');
        return;
    }
    
    // Convert string values to appropriate types
    data.domain_id = parseInt(data.domain_id);
    data.duration_minutes = parseInt(data.duration_minutes);
    
    console.log('Interview data:', data);
    
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = true;
    startBtn.textContent = 'Starting Interview...';
    
    try {
        console.log('Making API call to start interview');
        const response = await fetch('/api/start-interview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        console.log('API response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('API response:', result);
        
        if (result.interview_id) {
            console.log('Redirecting to interview page');
            window.location.href = `/interview/${result.interview_id}`;
        } else {
            throw new Error('No interview ID received');
        }
        
    } catch (error) {
        console.error('Error starting interview:', error);
        alert('Failed to start interview: ' + error.message);
    } finally {
        startBtn.disabled = false;
        startBtn.textContent = 'Start Interview';
    }
});

// Handle difficulty selection
document.querySelectorAll('input[name="difficulty_level"]').forEach(radio => {
    radio.addEventListener('change', function() {
        console.log('Difficulty selected:', this.value);
        
        // Reset all options
        document.querySelectorAll('.difficulty-option').forEach(option => {
            option.style.borderColor = '#d1d5db';
            option.style.backgroundColor = 'white';
        });
        
        // Highlight selected option
        if (this.checked) {
            const option = this.nextElementSibling;
            option.style.borderColor = '#3b82f6';
            option.style.backgroundColor = '#eff6ff';
        }
    });
});

// Test API endpoint availability
fetch('/api/domains')
    .then(response => response.json())
    .then(data => console.log('Domains loaded:', data))
    .catch(error => console.error('Error loading domains:', error));
</script>
{% endblock %}
